#!/bin/bash
# filepath: run_pipeline.sh
# ç°¡åŒ–ç‰ˆæœ¬ï¼šMulti-Stock DRL Trading Pipeline

# ============================================
# è¨­å®š
# ============================================
CONFIG_FILE="./configs/defaults.yaml"
MODEL_DIR="./models"
LOG_DIR="./logs"

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
NC='\033[0m'

# ============================================
# å‡½æ•¸ï¼šé¡¯ç¤ºå¹«åŠ©
# ============================================

show_help() {
    cat << EOF
${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}
${BLUE}  Multi-Stock DRL Trading Pipeline (ç°¡åŒ–ç‰ˆ)${NC}
${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}

${GREEN}ä½¿ç”¨æ–¹å¼:${NC} ./run_pipeline.sh [å‘½ä»¤] [é¸é …]

${YELLOW}ğŸ“‹ æŸ¥çœ‹é…ç½®:${NC}
  view                    æŸ¥çœ‹æ‰€æœ‰ Agent é…ç½®
  view-sub                æŸ¥çœ‹ Sub-Agent é…ç½®
  view-final              æŸ¥çœ‹ Final Agent é…ç½®

${YELLOW}ğŸ”§ ä¿®æ”¹é…ç½®:${NC}
  set-algo <agent> <algo> [model]
                          ä¿®æ”¹ Agent ä½¿ç”¨çš„æ¼”ç®—æ³•å’Œæ¨¡å‹
                          ä¾‹: set-algo sub-0 a2c mlp
                          ä¾‹: set-algo final ddpg mscnn
  
  set-attention <on|off> [type] [heads]
                          å•Ÿç”¨/ç¦ç”¨ Final Agent æ³¨æ„åŠ›æ©Ÿåˆ¶
                          ä¾‹: set-attention on sequence 4
                          ä¾‹: set-attention off

${YELLOW}ğŸš€ è¨“ç·´:${NC}
  train <agent>           è¨“ç·´æŒ‡å®š Agent
                          agent: sub-0, sub-1, sub-2, final, all
                          ä¾‹: train sub-0
                          ä¾‹: train final
  
  train-parallel [N]      å¹³è¡Œè¨“ç·´ Sub-Agents
                          N: worker æ•¸é‡ (é è¨­: Sub-Agent æ•¸é‡)
                          ä¾‹: train-parallel 4
  
  train-final-with-subs   è¨“ç·´ Final Agent (ä½¿ç”¨å·²è¨“ç·´çš„ Sub-Agents)
                          å‰æ: Sub-Agents æ¨¡å‹å¿…é ˆå·²å­˜åœ¨
                          ä¾‹: train-final-with-subs
  
  train-all               å®Œæ•´æµç¨‹ï¼šå¹³è¡Œè¨“ç·´æ‰€æœ‰ Sub-Agents -> è¨“ç·´ Final Agent
                          ä¾‹: train-all

${YELLOW}ğŸ§ª è©•ä¼°:${NC}
  eval <agent>            è©•ä¼°æŒ‡å®š Agent
                          ä¾‹: eval final
  
  eval-all                è©•ä¼°æ‰€æœ‰ Agent

${YELLOW}ğŸ“Š å·¥å…·:${NC}
  list-models             åˆ—å‡ºå·²è¨“ç·´çš„æ¨¡å‹
  list-sub-models         åˆ—å‡ºå·²è¨“ç·´çš„ Sub-Agent æ¨¡å‹
  clean-models            åˆªé™¤æ‰€æœ‰æ¨¡å‹æª”æ¡ˆ
  clean-logs              åˆªé™¤æ‰€æœ‰æ—¥èªŒæª”æ¡ˆ
  status                  æª¢æŸ¥ç³»çµ±ç‹€æ…‹
  gpu-status              æª¢æŸ¥ GPU ç‹€æ…‹

${YELLOW}â„¹ï¸ å…¶ä»–:${NC}
  help                    é¡¯ç¤ºæ­¤å¹«åŠ©

${GREEN}ç¯„ä¾‹ - å®Œæ•´æµç¨‹ 1ï¼ˆæ¨è–¦ï¼‰:${NC}
  # å¹³è¡Œè¨“ç·´æ‰€æœ‰ Sub-Agentsï¼Œç„¶å¾Œè¨“ç·´ Final Agent
  ./run_pipeline.sh train-all

${GREEN}ç¯„ä¾‹ - å®Œæ•´æµç¨‹ 2ï¼ˆé€æ­¥æ“ä½œï¼‰:${NC}
  # æ­¥é©Ÿ 1: æŸ¥çœ‹é…ç½®
  ./run_pipeline.sh view
  
  # æ­¥é©Ÿ 2: ä¿®æ”¹é…ç½®
  ./run_pipeline.sh set-algo final ddpg mscnn
  ./run_pipeline.sh set-attention on sequence 4
  
  # æ­¥é©Ÿ 3: å¹³è¡Œè¨“ç·´ Sub-Agents (4 å€‹ workers)
  ./run_pipeline.sh train-parallel 4
  
  # æ­¥é©Ÿ 4: è¨“ç·´ Final Agent (ä½¿ç”¨å·²è¨“ç·´çš„ Sub-Agents)
  ./run_pipeline.sh train-final-with-subs
  
  # æ­¥é©Ÿ 5: è©•ä¼°
  ./run_pipeline.sh eval-all

${GREEN}ç¯„ä¾‹ - é€å€‹è¨“ç·´:${NC}
  ./run_pipeline.sh train sub-0
  ./run_pipeline.sh train sub-1
  ./run_pipeline.sh train sub-2
  ./run_pipeline.sh train-final-with-subs

${GREEN}ç¯„ä¾‹ - ä¿®æ”¹é…ç½®:${NC}
  ./run_pipeline.sh set-algo sub-0 a2c timesnet
  ./run_pipeline.sh set-algo final ddpg mscnn
  ./run_pipeline.sh set-attention on sequence 4

EOF
}

# ============================================
# å‡½æ•¸ï¼šYAML é…ç½®æ“ä½œ
# ============================================

# è®€å– YAML å€¼
get_yaml_value() {
    local file="$1"
    local path="$2"  # å¦‚: "agent_mode.final_agent.algorithm"
    
    python3 << EOF
import yaml
with open('$file', 'r') as f:
    config = yaml.safe_load(f)

keys = '$path'.split('.')
value = config
for key in keys:
    value = value.get(key, {})
print(value if value else 'N/A')
EOF
}

# è¨­å®š YAML å€¼
set_yaml_value() {
    local file="$1"
    local path="$2"  # å¦‚: "agent_mode.final_agent.algorithm"
    local value="$3"
    
    python3 << EOF
import yaml
with open('$file', 'r') as f:
    config = yaml.safe_load(f)

keys = '$path'.split('.')
target = config
for key in keys[:-1]:
    if key not in target:
        target[key] = {}
    target = target[key]

target[keys[-1]] = $value

with open('$file', 'w') as f:
    yaml.dump(config, f, default_flow_style=False, allow_unicode=True)

print('âœ“ å·²è¨­å®š $path = $value')
EOF
}

# ============================================
# å‡½æ•¸ï¼šæŸ¥çœ‹é…ç½®
# ============================================

view_config() {
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}  Agent é…ç½®ç¸½è¦½${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    
    python3 << 'EOF'
import yaml

with open('./configs/defaults.yaml', 'r') as f:
    config = yaml.safe_load(f)

agent_mode = config['agent_mode']['mode']
print(f"ğŸ”¹ Agent æ¨¡å¼: {agent_mode.upper()}\n")

# Sub-Agents
print("ğŸ“Œ Sub-Agents:")
print("â”€" * 70)
print(f"{'ç´¢å¼•':<6} {'åç¨±':<20} {'æ¼”ç®—æ³•':<10} {'æ¨¡å‹':<15} {'æ³¨æ„åŠ›':<10}")
print("â”€" * 70)

sub_agents = config['agent_mode'].get('sub_agents', [])
for i, agent in enumerate(sub_agents):
    name = agent.get('name', 'Unknown')
    algo = agent.get('algorithm', 'N/A').upper()
    model = agent.get('model_type', 'N/A').upper()
    attn = "âœ—" if not agent.get('use_attention', False) else "âœ“"
    print(f"{i:<6} {name:<20} {algo:<10} {model:<15} {attn:<10}")

print("\nğŸ“Œ Final Agent:")
print("â”€" * 70)

final = config['agent_mode'].get('final_agent', {})
algo = final.get('algorithm', 'N/A').upper()
model = final.get('model_type', 'N/A').upper()
use_attn = final.get('use_attention', False)
attn_type = final.get('attention_type', 'N/A') if use_attn else 'â”€'
num_heads = final.get('num_heads', 'N/A') if use_attn else 'â”€'

print(f"  æ¼”ç®—æ³•: {algo}")
print(f"  æ¨¡å‹: {model}")
print(f"  æ³¨æ„åŠ›: {'âœ“ å•Ÿç”¨' if use_attn else 'âœ— ç¦ç”¨'}")
if use_attn:
    print(f"    - é¡å‹: {attn_type}")
    print(f"    - é ­æ•¸: {num_heads}")

print("\n" + "â”€" * 70)
EOF
}

view_sub_agents() {
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}  Sub-Agents è©³ç´°é…ç½®${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    
    python3 << 'EOF'
import yaml

with open('./configs/defaults.yaml', 'r') as f:
    config = yaml.safe_load(f)

sub_agents = config['agent_mode'].get('sub_agents', [])

for i, agent in enumerate(sub_agents):
    print(f"[Sub-Agent {i}] {agent.get('name', 'Unknown')}")
    print(f"  Agent Type: {agent.get('agent_type', 'N/A')}")
    print(f"  Algorithm: {agent.get('algorithm', 'N/A').upper()}")
    print(f"  Model Type: {agent.get('model_type', 'N/A').upper()}")
    print(f"  Use Attention: {agent.get('use_attention', False)}")
    print()
EOF
}

view_final_agent() {
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}  Final Agent è©³ç´°é…ç½®${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    
    python3 << 'EOF'
import yaml

with open('./configs/defaults.yaml', 'r') as f:
    config = yaml.safe_load(f)

final = config['agent_mode'].get('final_agent', {})

print(f"åç¨±: {final.get('name', 'Final Agent')}")
print(f"Agent Type: {final.get('agent_type', 'N/A')}")
print(f"Algorithm: {final.get('algorithm', 'N/A').upper()}")
print(f"Model Type: {final.get('model_type', 'N/A').upper()}")
print(f"\næ³¨æ„åŠ›æ©Ÿåˆ¶é…ç½®:")
print(f"  å•Ÿç”¨: {'âœ“ æ˜¯' if final.get('use_attention', False) else 'âœ— å¦'}")
if final.get('use_attention', False):
    print(f"  é¡å‹: {final.get('attention_type', 'N/A')}")
    print(f"  é ­æ•¸: {final.get('num_heads', 4)}")
EOF
}

# ============================================
# å‡½æ•¸ï¼šä¿®æ”¹é…ç½®
# ============================================

set_agent_algo() {
    local agent="$1"
    local algo="$2"
    local model="$3"
    
    if [ -z "$agent" ] || [ -z "$algo" ]; then
        echo -e "${RED}âŒ ç”¨æ³•: set-algo <agent> <algo> [model]${NC}"
        echo "  agent: sub-0, sub-1, sub-2, final"
        echo "  algo: a2c, ddpg, ddqn, ppo"
        echo "  model: mlp, bilstm, lstm, mscnn, timesnet (å¯é¸)"
        return 1
    fi
    
    # é è¨­æ¨¡å‹å‹åˆ¥
    [ -z "$model" ] && model="mlp"
    
    echo -e "${YELLOW}ä¿®æ”¹ $agent é…ç½®...${NC}"
    
    python3 << EOF
import yaml
import sys

with open('./configs/defaults.yaml', 'r') as f:
    config = yaml.safe_load(f)

agent = '$agent'.lower()
algo = '$algo'.lower()
model = '$model'.lower()

# é©—è­‰è¼¸å…¥
valid_algos = ['a2c', 'ddpg', 'ddqn', 'ppo']
valid_models = ['mlp', 'bilstm', 'lstm', 'mscnn', 'timesnet']

if algo not in valid_algos:
    print(f"âŒ ç„¡æ•ˆçš„æ¼”ç®—æ³•: {algo} (æœ‰æ•ˆå€¼: {', '.join(valid_algos)})")
    sys.exit(1)

if model not in valid_models:
    print(f"âŒ ç„¡æ•ˆçš„æ¨¡å‹: {model} (æœ‰æ•ˆå€¼: {', '.join(valid_models)})")
    sys.exit(1)

# ä¿®æ”¹é…ç½®
if agent == 'final':
    config['agent_mode']['final_agent']['algorithm'] = algo
    config['agent_mode']['final_agent']['model_type'] = model
    print(f"âœ“ Final Agent å·²æ›´æ–°:")
    print(f"  Algorithm: {algo.upper()}")
    print(f"  Model: {model.upper()}")
elif agent.startswith('sub-'):
    try:
        idx = int(agent.split('-')[1])
        sub_agents = config['agent_mode'].get('sub_agents', [])
        if 0 <= idx < len(sub_agents):
            sub_agents[idx]['algorithm'] = algo
            sub_agents[idx]['model_type'] = model
            print(f"âœ“ Sub-Agent {idx} å·²æ›´æ–°:")
            print(f"  Name: {sub_agents[idx].get('name', 'Unknown')}")
            print(f"  Algorithm: {algo.upper()}")
            print(f"  Model: {model.upper()}")
        else:
            print(f"âŒ Sub-Agent ç´¢å¼•è¶…å‡ºç¯„åœ: {idx}")
            sys.exit(1)
    except ValueError:
        print(f"âŒ ç„¡æ•ˆçš„ Agent æ ¼å¼: {agent}")
        sys.exit(1)
else:
    print(f"âŒ ç„¡æ•ˆçš„ Agent: {agent}")
    sys.exit(1)

with open('./configs/defaults.yaml', 'w') as f:
    yaml.dump(config, f, default_flow_style=False, allow_unicode=True)
EOF
}

set_attention() {
    local enable="$1"
    local attn_type="${2:-sequence}"
    local num_heads="${3:-4}"
    
    if [ -z "$enable" ]; then
        echo -e "${RED}âŒ ç”¨æ³•: set-attention <on|off> [type] [heads]${NC}"
        echo "  type: simple, sequence (é è¨­: sequence)"
        echo "  heads: æ­£æ•´æ•¸ (é è¨­: 4)"
        return 1
    fi
    
    if [ "$enable" != "on" ] && [ "$enable" != "off" ]; then
        echo -e "${RED}âŒ ç„¡æ•ˆçš„é¸é …: $enable (æ‡‰ç‚º on æˆ– off)${NC}"
        return 1
    fi
    
    local use_attn="True"
    [ "$enable" = "off" ] && use_attn="False"
    
    echo -e "${YELLOW}ä¿®æ”¹ Final Agent æ³¨æ„åŠ›æ©Ÿåˆ¶...${NC}"
    
    python3 << EOF
import yaml

with open('./configs/defaults.yaml', 'r') as f:
    config = yaml.safe_load(f)

if 'final_agent' not in config['agent_mode']:
    config['agent_mode']['final_agent'] = {}

config['agent_mode']['final_agent']['use_attention'] = $use_attn
if $use_attn:
    config['agent_mode']['final_agent']['attention_type'] = '$attn_type'
    config['agent_mode']['final_agent']['num_heads'] = $num_heads

with open('./configs/defaults.yaml', 'w') as f:
    yaml.dump(config, f, default_flow_style=False, allow_unicode=True)

status = 'âœ“ å·²å•Ÿç”¨' if $use_attn else 'âœ“ å·²ç¦ç”¨'
print(f"{status} Final Agent æ³¨æ„åŠ›æ©Ÿåˆ¶")
if $use_attn:
    print(f"  é¡å‹: $attn_type")
    print(f"  é ­æ•¸: $num_heads")
EOF
}

# ============================================
# å‡½æ•¸ï¼šè¨“ç·´
# ============================================

train_agent() {
    local agent="$1"
    
    if [ -z "$agent" ]; then
        echo -e "${RED}âŒ ç”¨æ³•: train <agent>${NC}"
        echo "  agent: sub-0, sub-1, sub-2, final, all"
        return 1
    fi
    
    agent=$(echo "$agent" | tr '[:upper:]' '[:lower:]')
    
    # è¨­å®šæ“ä½œæ¨¡å¼
    python3 << EOF
import yaml
with open('./configs/defaults.yaml', 'r') as f:
    config = yaml.safe_load(f)
config['agent_mode']['operation'] = 'training'
with open('./configs/defaults.yaml', 'w') as f:
    yaml.dump(config, f, default_flow_style=False, allow_unicode=True)
EOF
    
    echo -e "${MAGENTA}é–‹å§‹è¨“ç·´: $agent${NC}\n"
    
    if [ "$agent" = "all" ]; then
        # è¨“ç·´æ‰€æœ‰ Agentï¼ˆåŒ…æ‹¬ sub å’Œ finalï¼‰
        python3 main.py --train --config ./configs/defaults.yaml
    elif [ "$agent" = "final" ]; then
        # è¨“ç·´ Final Agentï¼ˆå‡è¨­ sub-agents å·²è¨“ç·´ï¼‰
        python3 main.py --train --config ./configs/defaults.yaml
    elif [[ "$agent" =~ ^sub-[0-9]+$ ]]; then
        # è¨“ç·´å–®å€‹ Sub-Agent
        idx=$(echo "$agent" | cut -d'-' -f2)
        python3 main.py --train --config ./configs/defaults.yaml --train-sub-agent "$idx"
    else
        echo -e "${RED}âŒ ç„¡æ•ˆçš„ Agent: $agent${NC}"
        return 1
    fi
}

train_parallel() {
    local num_workers="$1"
    
    # é è¨­ä½¿ç”¨ Sub-Agent æ•¸é‡
    if [ -z "$num_workers" ]; then
        num_workers=$(python3 << 'EOF'
import yaml
with open('./configs/defaults.yaml', 'r') as f:
    config = yaml.safe_load(f)
sub_agents = config['agent_mode'].get('sub_agents', [])
print(len(sub_agents))
EOF
)
    fi
    
    echo -e "${MAGENTA}å¹³è¡Œè¨“ç·´ Sub-Agents (${num_workers} workers)${NC}\n"
    
    # è¨­å®šæ“ä½œæ¨¡å¼
    python3 << EOF
import yaml
with open('./configs/defaults.yaml', 'r') as f:
    config = yaml.safe_load(f)
config['agent_mode']['operation'] = 'training'
config['agent_mode']['mode'] = 'multi-agent'
config['agent_mode']['num_workers'] = $num_workers
with open('./configs/defaults.yaml', 'w') as f:
    yaml.dump(config, f, default_flow_style=False, allow_unicode=True)
EOF
    
    python3 main.py --train --config ./configs/defaults.yaml --num-workers $num_workers
}

train_final_with_subs() {
    echo -e "${MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${MAGENTA}è¨“ç·´ Final Agent (ä½¿ç”¨å·²è¨“ç·´çš„ Sub-Agents)${NC}"
    echo -e "${MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    
    # æª¢æŸ¥ Sub-Agent æ¨¡å‹æ˜¯å¦å­˜åœ¨
    python3 << 'PYEOF'
import os
import yaml

with open('./configs/defaults.yaml', 'r') as f:
    config = yaml.safe_load(f)

sub_agents = config['agent_mode'].get('sub_agents', [])
missing_models = []

print("æª¢æŸ¥ Sub-Agent æ¨¡å‹...")
print("â”€" * 70)

for i, agent in enumerate(sub_agents):
    name = agent.get('name', f'Sub-Agent-{i}')
    model_path = f"./models/sub_agents/{name}_agent.pth"
    
    if os.path.exists(model_path):
        size = os.path.getsize(model_path) / 1024 / 1024  # MB
        print(f"  âœ“ [{i}] {name}: {size:.2f} MB")
    else:
        print(f"  âœ— [{i}] {name}: NOT FOUND")
        missing_models.append(name)

print("â”€" * 70)

if missing_models:
    print(f"\nâŒ ç¼ºå°‘ä»¥ä¸‹æ¨¡å‹:")
    for model in missing_models:
        print(f"  - {model}")
    print(f"\nè«‹å…ˆåŸ·è¡Œä»¥ä¸‹å‘½ä»¤è¨“ç·´ Sub-Agents:")
    print(f"  ./run_pipeline.sh train-parallel [N]  # å¹³è¡Œè¨“ç·´æ‰€æœ‰ Sub-Agents")
    print(f"  æˆ–é€å€‹è¨“ç·´:")
    for i in range(len(sub_agents)):
        print(f"  ./run_pipeline.sh train sub-{i}")
    exit(1)
else:
    print(f"\nâœ“ æ‰€æœ‰ Sub-Agent æ¨¡å‹å·²å°±ç·’\n")

PYEOF

    if [ $? -ne 0 ]; then
        return 1
    fi
    
    # è¨­å®šæ“ä½œæ¨¡å¼
    python3 << EOF
import yaml
with open('./configs/defaults.yaml', 'r') as f:
    config = yaml.safe_load(f)
config['agent_mode']['operation'] = 'training'
config['agent_mode']['mode'] = 'multi-agent'
config['agent_mode']['train_final_only'] = True
with open('./configs/defaults.yaml', 'w') as f:
    yaml.dump(config, f, default_flow_style=False, allow_unicode=True)
EOF

    echo -e "${MAGENTA}é–‹å§‹è¨“ç·´ Final Agent...${NC}\n"
    python3 main.py --train --config ./configs/defaults.yaml --train-final-only
}

train_all() {
    echo -e "${MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${MAGENTA}å®Œæ•´æµç¨‹ï¼šå¹³è¡Œè¨“ç·´ Sub-Agents â†’ è¨“ç·´ Final Agent${NC}"
    echo -e "${MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    
    # ç²å– Sub-Agent æ•¸é‡
    num_workers=$(python3 << 'EOF'
import yaml
with open('./configs/defaults.yaml', 'r') as f:
    config = yaml.safe_load(f)
sub_agents = config['agent_mode'].get('sub_agents', [])
print(len(sub_agents))
EOF
)
    
    echo -e "${MAGENTA}[æ­¥é©Ÿ 1/2] å¹³è¡Œè¨“ç·´ ${num_workers} å€‹ Sub-Agents...${NC}\n"
    train_parallel $num_workers
    
    echo -e "\n${MAGENTA}[æ­¥é©Ÿ 2/2] è¨“ç·´ Final Agent...${NC}\n"
    train_final_with_subs
    
    echo -e "\n${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}âœ… å®Œæ•´æµç¨‹å®Œæˆï¼${NC}"
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
}

# ============================================
# å‡½æ•¸ï¼šè©•ä¼°
# ============================================

eval_agent() {
    local agent="$1"
    
    if [ -z "$agent" ]; then
        echo -e "${RED}âŒ ç”¨æ³•: eval <agent>${NC}"
        echo "  agent: sub-0, sub-1, sub-2, final"
        return 1
    fi
    
    # è¨­å®šæ“ä½œæ¨¡å¼
    python3 << EOF
import yaml
with open('./configs/defaults.yaml', 'r') as f:
    config = yaml.safe_load(f)
config['agent_mode']['operation'] = 'evaluation'
with open('./configs/defaults.yaml', 'w') as f:
    yaml.dump(config, f, default_flow_style=False, allow_unicode=True)
EOF
    
    echo -e "${MAGENTA}è©•ä¼° Agent: $agent${NC}\n"
    python3 main.py --eval --config ./configs/defaults.yaml
}

eval_all() {
    echo -e "${MAGENTA}è©•ä¼°æ‰€æœ‰ Agent${NC}\n"
    
    # è¨­å®šæ“ä½œæ¨¡å¼
    python3 << EOF
import yaml
with open('./configs/defaults.yaml', 'r') as f:
    config = yaml.safe_load(f)
config['agent_mode']['operation'] = 'evaluation'
with open('./configs/defaults.yaml', 'w') as f:
    yaml.dump(config, f, default_flow_style=False, allow_unicode=True)
EOF
    
    python3 main.py --eval --config ./configs/defaults.yaml
}

# ============================================
# å‡½æ•¸ï¼šå·¥å…·
# ============================================

list_models() {
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}  å·²è¨“ç·´çš„æ¨¡å‹${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    
    if ls ${MODEL_DIR}/*.pth 1>/dev/null 2>&1; then
        echo -e "${YELLOW}ğŸ“Œ ä¸»æ¨¡å‹ (Final Agent):${NC}"
        ls -lh ${MODEL_DIR}/*.pth 2>/dev/null | awk '{print "  ğŸ“¦ " $9 " (Size: " $5 ")"}'
    fi
    
    if ls ${MODEL_DIR}/sub_agents/*.pth 1>/dev/null 2>&1; then
        echo -e "\n${YELLOW}ğŸ“Œ Sub-Agent æ¨¡å‹${NC}"
        ls -lh ${MODEL_DIR}/sub_agents/*.pth 2>/dev/null | awk '{print "  ğŸ“¦ " $9 " (Size: " $5 ")"}'
    fi
    
    if ! ls ${MODEL_DIR}/*.pth ${MODEL_DIR}/sub_agents/*.pth 1>/dev/null 2>&1; then
        echo -e "${YELLOW}ç„¡å·²è¨“ç·´çš„æ¨¡å‹${NC}"
    fi
    echo ""
}

list_sub_models() {
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}  å·²è¨“ç·´çš„ Sub-Agent æ¨¡å‹${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    
    python3 << 'EOF'
import os
import yaml

with open('./configs/defaults.yaml', 'r') as f:
    config = yaml.safe_load(f)

sub_agents = config['agent_mode'].get('sub_agents', [])

print(f"{'ç´¢å¼•':<6} {'åç¨±':<25} {'æ¼”ç®—æ³•':<12} {'æ¨¡å‹':<15} {'ç‹€æ…‹':<10} {'å¤§å°':<10}")
print("â”€" * 90)

for i, agent in enumerate(sub_agents):
    name = agent.get('name', f'Sub-Agent-{i}')
    algo = agent.get('algorithm', 'N/A').upper()
    model_type = agent.get('model_type', 'N/A').upper()
    
    model_path = f"./models/sub_agents/{name}_agent.pth"
    
    if os.path.exists(model_path):
        size = os.path.getsize(model_path) / 1024 / 1024  # MB
        status = "âœ“ å­˜åœ¨"
        print(f"{i:<6} {name:<25} {algo:<12} {model_type:<15} {status:<10} {size:.2f} MB")
    else:
        status = "âœ— ç¼ºå¤±"
        print(f"{i:<6} {name:<25} {algo:<12} {model_type:<15} {status:<10} {'â”€':<10}")

print("â”€" * 90)
EOF
    echo ""
}

clean_models() {
    echo -e "${YELLOW}ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰æ¨¡å‹æª”æ¡ˆå—ï¼Ÿ(y/N)${NC}"
    read -r confirm
    if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
        rm -rf ${MODEL_DIR}/*.pth ${MODEL_DIR}/sub_agents/*.pth 2>/dev/null
        echo -e "${GREEN}âœ“ æ¨¡å‹æª”æ¡ˆå·²æ¸…ç†${NC}"
    fi
}

clean_logs() {
    echo -e "${YELLOW}ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰æ—¥èªŒæª”æ¡ˆå—ï¼Ÿ(y/N)${NC}"
    read -r confirm
    if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
        rm -rf ${LOG_DIR}/*.log ${LOG_DIR}/*.csv 2>/dev/null
        echo -e "${GREEN}âœ“ æ—¥èªŒæª”æ¡ˆå·²æ¸…ç†${NC}"
    fi
}

check_status() {
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}  ç³»çµ±ç‹€æ…‹${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    
    echo -e "${YELLOW}Python & PyTorch:${NC}"
    python3 --version 2>&1 | sed 's/^/  /'
    python3 -c "import torch; print(f'  PyTorch: {torch.__version__}')" 2>/dev/null
    python3 -c "import torch; print(f'  CUDA: {\"å¯ç”¨\" if torch.cuda.is_available() else \"ä¸å¯ç”¨\"}')" 2>/dev/null
    
    echo -e "\n${YELLOW}ç›®éŒ„:${NC}"
    [ -d "./data" ] && echo "  âœ“ data/" || echo "  âœ— data/"
    [ -d "$MODEL_DIR" ] && echo "  âœ“ $MODEL_DIR/" || echo "  âœ— $MODEL_DIR/"
    [ -d "$LOG_DIR" ] && echo "  âœ“ $LOG_DIR/" || echo "  âœ— $LOG_DIR/"
    
    echo -e "\n${YELLOW}è¨“ç·´é€²ç¨‹:${NC}"
    local count=$(pgrep -f "python.*main.py" 2>/dev/null | wc -l)
    if [ "$count" -gt 0 ]; then
        echo -e "  ${GREEN}â— æœ‰ $count å€‹è¨“ç·´é€²ç¨‹åŸ·è¡Œä¸­${NC}"
    else
        echo "  â—‹ ç„¡è¨“ç·´é€²ç¨‹"
    fi
    echo ""
}

check_gpu() {
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}  GPU ç‹€æ…‹${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    
    if command -v nvidia-smi &>/dev/null; then
        nvidia-smi --query-gpu=index,name,memory.total,memory.used,utilization.gpu \
            --format=csv,noheader | awk '{print "  GPU " $1 ": " $2 " (" $3 ", ä½¿ç”¨: " $4 ", åˆ©ç”¨ç‡: " $5 ")"}'
    else
        python3 << 'EOF'
import torch
print(f"  CUDA available: {torch.cuda.is_available()}")
if torch.cuda.is_available():
    print(f"  GPU count: {torch.cuda.device_count()}")
    for i in range(torch.cuda.device_count()):
        print(f"    GPU {i}: {torch.cuda.get_device_name(i)}")
EOF
    fi
    echo ""
}

# ============================================
# ä¸»ç¨‹åº
# ============================================

if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

case "$1" in
    help|-h|--help)
        show_help
        ;;
    view)
        view_config
        ;;
    view-sub|view-sub-agents)
        view_sub_agents
        ;;
    view-final|view-final-agent)
        view_final_agent
        ;;
    set-algo)
        set_agent_algo "$2" "$3" "$4"
        ;;
    set-attention)
        set_attention "$2" "$3" "$4"
        ;;
    train)
        train_agent "$2"
        ;;
    train-parallel)
        train_parallel "$2"
        ;;
    train-final-with-subs)
        train_final_with_subs
        ;;
    train-all)
        train_all
        ;;
    eval)
        eval_agent "$2"
        ;;
    eval-all)
        eval_all
        ;;
    list-models)
        list_models
        ;;
    list-sub-models)
        list_sub_models
        ;;
    clean-models)
        clean_models
        ;;
    clean-logs)
        clean_logs
        ;;
    status)
        check_status
        ;;
    gpu-status)
        check_gpu
        ;;
    backtest|backtest-all)
        echo -e "${MAGENTA}å›æ¸¬æ‰€æœ‰æ¨¡å‹${NC}\n"
        python3 backtest_cli.py --all --num-episodes 10
        ;;
    
    backtest-agent)
        if [ -z "$2" ]; then
            echo -e "${RED}âŒ ç”¨æ³•: backtest-agent <agent_name>${NC}"
            return 1
        fi
        echo -e "${MAGENTA}å›æ¸¬ Agent: $2${NC}\n"
        python3 backtest_cli.py --agent "$2" --num-episodes 10
        ;;
    
    backtest-final)
        echo -e "${MAGENTA}å›æ¸¬ Final Agent${NC}\n"
        python3 backtest_cli.py --agent "Final_Agent" --num-episodes 10
        ;;
    *)
        echo -e "${RED}âŒ æœªçŸ¥å‘½ä»¤: $1${NC}"
        echo "ä½¿ç”¨ ./run_pipeline.sh help æŸ¥çœ‹å¹«åŠ©"
        exit 1
        ;;
esac